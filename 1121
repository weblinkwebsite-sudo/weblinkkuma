<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Oscar Awards (Final)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --gold: #d4af37;
            --dark-gold: #b8860b;
            --bg: #1a1a1a;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            background-image: radial-gradient(circle at center, #444 0%, #000 90%);
            color: var(--gold);
            font-family: 'Times New Roman', serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- é ‚éƒ¨è¨­å®šå€ --- */
        .header-controls {
            width: 100%;
            padding: 15px;
            background: rgba(0,0,0,0.85);
            border-bottom: 1px solid var(--gold);
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        .input-group label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 2px;
        }

        input[type="text"], input[type="number"] {
            background: #333;
            border: 1px solid var(--gold);
            color: #fff;
            padding: 8px;
            font-size: 1.2rem;
            border-radius: 4px;
            font-family: 'Times New Roman', serif;
            text-align: center;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #fff;
            background: #444;
        }

        /* æª”æ¡ˆä¸Šå‚³èˆ‡åŒ¯å‡ºæŒ‰éˆ•å…±ç”¨æ¨£å¼ */
        .action-btn {
            border: 1px solid var(--gold);
            padding: 8px 15px;
            cursor: pointer;
            background: #000;
            color: var(--gold);
            border-radius: 4px;
            font-size: 1rem;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 25px;
            text-decoration: none;
            font-family: sans-serif;
        }
        .action-btn:hover { background: var(--gold); color: #000; }
        
        /* è®“ input file éš±è— */
        input[type="file"] { display: none; }

        /* --- ä¸»è¦é¡¯ç¤ºå€ --- */
        .main-stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
        }

        h1#mainTitle {
            font-size: 3.5rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin: 10px 0;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.6);
            text-align: center;
            max-width: 90%;
            line-height: 1.2;
            transition: all 0.3s ease;
        }

        .display-container {
            width: 85%;
            max-width: 1000px;
            min-height: 350px;
            border: 4px solid var(--gold);
            border-radius: 15px;
            background: rgba(20, 20, 20, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.15);
            margin: 20px 0;
            position: relative;
            padding: 30px;
            flex-wrap: wrap;
            gap: 20px;
            overflow-y: auto;
            max-height: 55vh;
        }

        .display-container::after {
            content: '';
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            pointer-events: none;
        }

        /* å–®äººä¸­ç */
        .single-winner { text-align: center; }
        .single-winner .name { font-size: 6rem; font-weight: bold; line-height: 1.1; text-shadow: 2px 2px 0 #000; }
        .single-winner .id { font-size: 2.5rem; color: #f1c40f; font-family: sans-serif; margin-top: 15px; letter-spacing: 2px; }

        /* å¤šäººä¸­çå¡ç‰‡ */
        .winner-card {
            background: linear-gradient(135deg, #333, #111);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 15px;
            width: 220px;
            text-align: center;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .winner-card .c-name { font-size: 1.8rem; font-weight: bold; color: #fff; margin-bottom: 5px; }
        .winner-card .c-id { font-size: 1rem; color: #d4af37; font-family: sans-serif; }

        /* æŒ‰éˆ• */
        button.draw-btn {
            background: linear-gradient(135deg, var(--dark-gold), #f1c40f, var(--dark-gold));
            border: 2px solid #fff;
            padding: 15px 60px;
            color: #000;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.6);
            transition: all 0.2s;
            font-family: 'Times New Roman', serif;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        button.draw-btn:hover { transform: scale(1.05); box-shadow: 0 0 35px #f1c40f; }
        button.draw-btn:disabled { background: #444; color: #777; border-color: #666; cursor: not-allowed; transform: none; box-shadow: none; }

        .info-bar { margin-top: 20px; color: #666; font-size: 1.1rem; }
        .info-bar span { color: #ccc; font-weight: bold; margin: 0 5px; }

        /* å³å´æ­·å²ç´€éŒ„ */
        .history-panel {
            position: absolute;
            right: 0; top: 83px; bottom: 0;
            width: 280px;
            background: rgba(0,0,0,0.6);
            border-left: 2px solid var(--gold);
            padding: 0;
            overflow-y: auto;
            z-index: 50;
            backdrop-filter: blur(5px);
        }
        .history-header {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #666;
            background: rgba(0,0,0,0.5);
            position: sticky;
            top: 0;
        }
        .history-header h3 { margin: 0; color: #fff; font-size: 1.2rem; }
        
        .history-content { padding: 10px 20px; }

        .history-group { margin-bottom: 25px; animation: fadeIn 0.5s; }
        .history-title { 
            background: linear-gradient(90deg, var(--gold), #b8860b); 
            color: #000; 
            padding: 6px 10px; 
            font-weight: bold; 
            text-align: center; 
            border-radius: 4px; 
            margin-bottom: 8px;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .history-item {
            display: flex; justify-content: space-between;
            border-bottom: 1px dashed #555;
            padding: 6px 2px; 
            color: #eee;
            font-size: 1.1rem;
        }
        .history-item span.hid { font-size: 0.9rem; color: #aaa; font-family: sans-serif; padding-top: 2px; }

        /* å‹•ç•« */
        @keyframes popIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes flash { 0% { opacity: 0.8; } 100% { opacity: 1; text-shadow: 0 0 40px #fff, 0 0 20px #f1c40f; } }
        .anim-flash { animation: flash 0.6s infinite alternate; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #222; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold); }

    </style>
</head>
<body>

    <!-- é ‚éƒ¨è¨­å®šå€ -->
    <div class="header-controls">
        <div class="input-group">
            <label for="file-upload" class="action-btn">ğŸ“‚ åŒ¯å…¥åå–®</label>
            <input id="file-upload" type="file" accept=".xlsx, .xls"/>
        </div>

        <div class="input-group">
            <label class="action-btn" style="cursor: pointer;" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡ºçµæœ</label>
        </div>
        
        <div class="input-group" style="flex: 1; max-width: 300px;">
            <label>ğŸ† çé …åç¨±</label>
            <input type="text" id="prizeName" placeholder="ä¾‹å¦‚ï¼šç¸½ç¶“ç†ç" autocomplete="off">
        </div>

        <div class="input-group">
            <label>ğŸ‘¥ äººæ•¸</label>
            <input type="number" id="drawCount" value="1" min="1" max="100" style="width: 60px;">
        </div>
    </div>

    <!-- ä¸»èˆå° -->
    <div class="main-stage">
        <div style="font-size: 4rem; margin-bottom: -10px; filter: drop-shadow(0 0 10px gold);">ğŸ†</div>
        
        <h1 id="mainTitle">The Oscar Goes To...</h1>

        <div class="display-container" id="displayArea">
            <div class="single-winner">
                <div class="name" style="font-size: 4rem; color: #666;">ç­‰å¾…åŒ¯å…¥</div>
                <div class="id">...</div>
            </div>
        </div>

        <button id="drawBtn" class="draw-btn" onclick="toggleDraw()" disabled>Start Awards</button>

        <div class="info-bar">
            Total: <span id="totalCount">0</span> | 
            Remaining: <span id="remainCount" style="color: #f1c40f; font-size: 1.3rem;">0</span>
        </div>
    </div>

    <!-- å³å´æ­·å²ç´€éŒ„ -->
    <div class="history-panel">
        <div class="history-header">
            <h3>Winners List</h3>
        </div>
        <div class="history-content" id="historyContent">
            <!-- æ­·å²ç´€éŒ„æœƒæ’åœ¨é€™è£¡ -->
        </div>
    </div>

    <script>
        let candidates = [];
        let winnerHistory = []; // å„²å­˜æ‰€æœ‰å¾—çè€…çš„è³‡æ–™ï¼Œç”¨æ–¼åŒ¯å‡º
        let isRolling = false;
        let timer = null;

        // DOM å…ƒç´ 
        const displayArea = document.getElementById('displayArea');
        const drawBtn = document.getElementById('drawBtn');
        const prizeInput = document.getElementById('prizeName');
        const mainTitle = document.getElementById('mainTitle');
        const countInput = document.getElementById('drawCount');
        const totalSpan = document.getElementById('totalCount');
        const remainSpan = document.getElementById('remainCount');
        const historyContent = document.getElementById('historyContent');

        // æ¨™é¡ŒåŒæ­¥
        prizeInput.addEventListener('input', function() {
            const val = this.value.trim();
            if (val !== "") {
                mainTitle.innerText = val;
                mainTitle.style.color = "#fff";
            } else {
                mainTitle.innerText = "The Oscar Goes To...";
                mainTitle.style.color = "#d4af37";
            }
        });

        // 1. Excel åŒ¯å…¥é‚è¼¯
        document.getElementById('file-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                    candidates = [];
                    winnerHistory = []; // é‡æ–°åŒ¯å…¥æ™‚ï¼Œæ¸…ç©ºæ­·å²ç´€éŒ„
                    historyContent.innerHTML = ""; // æ¸…ç©ºç•«é¢ä¸Šçš„æ­·å²

                    jsonData.forEach((row) => {
                        if (row[0]) {
                            // å‡è¨­ç¬¬ä¸€æ¬„æ˜¯å§“åï¼Œç¬¬äºŒæ¬„æ˜¯ID (å¦‚æœæœ‰çš„è©±)
                            candidates.push({ name: row[0], id: row[1] || "" });
                        }
                    });

                    if (candidates.length > 0) {
                        // éæ¿¾æ¨™é¡Œåˆ— (å¦‚æœç¬¬ä¸€åˆ—åŒ…å«å¸¸è¦‹æ¨™é¡Œå­—çœ¼)
                        const first = candidates[0].name.toString();
                        if (first.includes("å§“å") || first.includes("Name")) candidates.shift();
                    }

                    if (candidates.length > 0) {
                        alert(`âœ… æˆåŠŸåŒ¯å…¥ ${candidates.length} ä½å€™é¸äºº (æ­·å²ç´€éŒ„å·²é‡ç½®)`);
                        displayArea.innerHTML = `<div class="single-winner"><div class="name" style="font-size:4rem">Ready</div></div>`;
                        drawBtn.disabled = false;
                        updateInfo();
                    } else {
                        alert("âŒ æª”æ¡ˆä¼¼ä¹æ˜¯ç©ºçš„æˆ–æ ¼å¼ä¸ç¬¦");
                    }
                } catch (err) {
                    alert("âŒ è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªä¸Šå‚³çš„æ˜¯æœ‰æ•ˆçš„ Excel æª”");
                    console.error(err);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // 2. æŠ½çæ§åˆ¶
        function toggleDraw() {
            if (candidates.length === 0) {
                alert("åå–®å·²å…¨æ•¸æŠ½å®Œï¼");
                return;
            }

            const wantCount = parseInt(countInput.value) || 1;
            if (wantCount > candidates.length) {
                alert(`å‰©é¤˜äººæ•¸ä¸è¶³ï¼ç›®å‰åªå‰© ${candidates.length} äººã€‚`);
                return;
            }

            if (isRolling) {
                stopDraw();
            } else {
                startDraw();
            }
        }

        function startDraw() {
            isRolling = true;
            drawBtn.innerText = "æ­ æ›‰ (STOP)";
            drawBtn.style.background = "linear-gradient(135deg, #c0392b, #e74c3c)"; // ç´…è‰²
            drawBtn.style.color = "#fff";
            
            displayArea.classList.remove('anim-flash');

            const wantCount = parseInt(countInput.value) || 1;

            timer = setInterval(() => {
                if (wantCount === 1) {
                    // å–®äººæ»¾å‹•
                    const r = candidates[Math.floor(Math.random() * candidates.length)];
                    displayArea.innerHTML = `
                        <div class="single-winner">
                            <div class="name">${r.name}</div>
                            <div class="id">${r.id}</div>
                        </div>`;
                } else {
                    // å¤šäººæ»¾å‹• (é¡¯ç¤ºå‡è³‡æ–™ç‰¹æ•ˆ)
                    let tempHtml = "";
                    const showLimit = Math.min(wantCount, 50); 
                    for(let i=0; i<showLimit; i++) {
                        const r = candidates[Math.floor(Math.random() * candidates.length)];
                        tempHtml += `
                            <div class="winner-card" style="opacity:0.8; transform:scale(0.95); border-color:#555;">
                                <div class="c-name">${r.name}</div>
                                <div class="c-id">Rolling...</div>
                            </div>`;
                    }
                    displayArea.innerHTML = tempHtml;
                }
            }, 50);
        }

        function stopDraw() {
            clearInterval(timer);
            isRolling = false;
            
            // 1. æŠ½å‡ºé‚è¼¯
            const wantCount = parseInt(countInput.value) || 1;
            const winners = [];

            for (let i = 0; i < wantCount; i++) {
                const index = Math.floor(Math.random() * candidates.length);
                winners.push(candidates[index]);
                candidates.splice(index, 1); // ç§»é™¤
            }

            // 2. é¡¯ç¤ºçµæœ
            if (wantCount === 1) {
                const w = winners[0];
                displayArea.innerHTML = `
                    <div class="single-winner anim-flash">
                        <div class="name">${w.name}</div>
                        <div class="id">${w.id}</div>
                    </div>`;
            } else {
                let html = "";
                winners.forEach(w => {
                    html += `
                        <div class="winner-card">
                            <div class="c-name">${w.name}</div>
                            <div class="c-id">${w.id}</div>
                        </div>`;
                });
                displayArea.innerHTML = html;
                displayArea.classList.add('anim-flash');
            }

            // 3. ç´€éŒ„è™•ç†
            let currentTitle = prizeInput.value.trim();
            if (!currentTitle) currentTitle = "æœªå‘½åçé …";
            
            // å­˜å…¥åŒ¯å‡ºé™£åˆ—
            winners.forEach(w => {
                winnerHistory.push({
                    "çé …": currentTitle,
                    "å§“å": w.name,
                    "å·¥è™Ÿ/ID": w.id
                });
            });

            // æ›´æ–°å³å´é¢æ¿
            addHistoryGroup(currentTitle, winners);

            // 4. å¾©åŸæŒ‰éˆ•
            drawBtn.innerText = "ä¸‹ä¸€è¼ª (NEXT)";
            drawBtn.style.background = "";
            drawBtn.style.color = "#000";
            updateInfo();
        }

        function updateInfo() {
            remainSpan.innerText = candidates.length;
            if (totalSpan.innerText === "0") totalSpan.innerText = candidates.length;
        }

        function addHistoryGroup(title, winnersList) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'history-group';

            let itemsHtml = '';
            winnersList.forEach(w => {
                itemsHtml += `
                    <div class="history-item">
                        <span>${w.name}</span>
                        <span class="hid">${w.id}</span>
                    </div>`;
            });

            groupDiv.innerHTML = `
                <div class="history-title">${title} (${winnersList.length})</div>
                ${itemsHtml}
            `;
            
            historyContent.insertBefore(groupDiv, historyContent.firstChild);
        }

        // 3. åŒ¯å‡º Excel åŠŸèƒ½
        function exportToExcel() {
            if (winnerHistory.length === 0) {
                alert("ç›®å‰é‚„æ²’æœ‰ä»»ä½•å¾—çè€…å¯ä»¥åŒ¯å‡ºå–”ï¼");
                return;
            }

            // å»ºç«‹ Worksheet
            const ws = XLSX.utils.json_to_sheet(winnerHistory);
            
            // å»ºç«‹ Workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "å¾—çåå–®");

            // ç”¢ç”Ÿæª”æ¡ˆåç¨± (å«æ™‚é–“)
            const now = new Date();
            const timeStr = now.getFullYear() + 
                String(now.getMonth()+1).padStart(2, '0') + 
                String(now.getDate()).padStart(2, '0') + "_" + 
                String(now.getHours()).padStart(2, '0') + 
                String(now.getMinutes()).padStart(2, '0');
            
            XLSX.writeFile(wb, `å¾—çåå–®_${timeStr}.xlsx`);
        }
    </script>
</body>
</html>
